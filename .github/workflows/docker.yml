name: Docker Image CI

on:
  push:
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron:  '0 2 * * *'

env:
  DOCKER_REPO: mahoney-playground/goos
  COMPOSE_DOCKER_CLI_BUILD: 1
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain

jobs:
  build:
    runs-on: ubuntu-18.04

    steps:
    - uses: actions/checkout@v2

    - name: Cache docker
      id: cache-docker
      uses: actions/cache@v1
      env:
        cache-name: docker-cache-1
      with:
        path: ${{ runner.temp }}/docker_cache
        key: ${{ env.cache-name }}-${{ github.run_number }}
        restore-keys: |
          ${{ env.cache-name }}-

    - name: Restore docker
      if: github.event_name != 'schedule' && steps.cache-primes.outputs.cache-hit == 'true'
      run: ./.github/restore.sh ${{ runner.temp }} ${{ runner.temp }}/docker_cache/cache.tar

    - name: Slim docker down
      if: github.event_name == 'schedule' || steps.cache-primes.outputs.cache-hit != 'true'
      run: docker system prune -a -f --volumes

    - name: Build App with Docker
      run: docker build . -t goos-app:${GITHUB_SHA}

    - name: Build Tests with Docker
      run: docker build . --target tests -t goos-tests:${GITHUB_SHA}

    - name: Backup docker
      run: ./.github/backup.sh ${{ runner.temp }}/docker_cache/cache.tar
